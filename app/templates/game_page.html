<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ game.description }}</title>
    <link rel="stylesheet" href="/static/css/game_page.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="header">
    <a href="/" class="header-link">BetChat.io</a>
</div>

<div id="roomId" data-id="{{ game.id }}"></div>

<div class="container">
    <div id="connectionStatus" class="alert alert-danger" role="alert" style="display: none;">
        Connecting...
    </div>

    <div class="chat-container">
        {% if live_data %}
        <div class="live-score-container d-flex justify-content-center mb-3">
            <div class="score-cell mr-2">
                <div class="team-name">{{ game.awayTeam }}</div>
                <div class="team-score">{{ live_data[0].latestScore.visitor }}</div>
            </div>
            <div class="score-cell ml-2">
                <div class="team-name">{{ game.homeTeam }}</div>
                <div class="team-score">{{ live_data[0].latestScore.home }}</div>
            </div>
        </div>
        <!-- Conditional display based on gameStatus -->
        {% if live_data[0].gameStatus != 'PRE_GAME' %}
        <div class="game-time">Period: {{ live_data[0].clock.period }} ({{ live_data[0].clock.gameTime }} left)</div>
        {% else %}
        <!-- Content to display if gameStatus is 'PRE_GAME' -->
        <div class="game-time">Pre-Game</div>
        {% endif %}
        <div class="sport-name">{{ game.sport }}</div>
        {% endif %}

        <!-- Projected Score Container -->
        <div class="projected-score-container d-flex justify-content-center mb-3">
            <div class="projected-score-box">
                <div class="projected-score-title">Projected Score</div>
                <div class="projected-scores">{{ betting_data.assumed_final_score.proj_away_score }} - {{ betting_data.assumed_final_score.proj_home_score }}</div>
            </div>
        </div>

        {% if betting_data %}
        <div class="betting-info mt-3">
            <div class="row">
                <!-- Moneyline Bets -->
                <div class="col-sm-4">
                    <div class="bet-box">
                        <h5>Moneyline</h5>
                        <div class="bet-odds-container">
                            <span class="bet-odds away-odds">{{ betting_data.moneyline_bets.away.odds }}</span>
                            <span class="bet-odds home-odds">{{ betting_data.moneyline_bets.home.odds }}</span>
                        </div>
                        <div class="probability-bar" id="moneylineJuiceAdjusted"
                             data-away-prob="{{ betting_data.moneyline_bets.away.probability }}"
                             data-home-prob="{{ betting_data.moneyline_bets.home.probability }}"
                             data-juice="{{ betting_data.moneyline_bets.away.juice }}">
                        </div>
                    </div>
                </div>
                <!-- Spread Bets -->
                <div class="col-sm-4">
                    <div class="bet-box">
                        <h5>Spread</h5>
                        <div class="bet-odds-container">
                            <span class="bet-odds away-spread">{{ betting_data.spread_bets.away.spread }} ({{ betting_data.spread_bets.away.odds }})</span>
                            <span class="bet-odds home-spread">{{ betting_data.spread_bets.home.spread }} ({{ betting_data.spread_bets.home.odds }})</span>
                        </div>
                        <div class="probability-bar" id="spreadJuiceAdjusted"
                             data-away-prob="{{ betting_data.spread_bets.away.probability }}"
                             data-home-prob="{{ betting_data.spread_bets.home.probability }}"
                             data-juice="{{ betting_data.spread_bets.away.juice }}">
                        </div>
                    </div>
                </div>
                <!-- Over/Under Bets -->
                <div class="col-sm-4">
                    <div class="bet-box">
                        <h5>Total</h5>
                        <div class="bet-odds-container">
                            <span class="bet-odds under-odds">u{{ betting_data.over_under_bets.under.total }} ({{ betting_data.over_under_bets.under.odds }})</span>
                            <span class="bet-odds over-odds">o{{ betting_data.over_under_bets.over.total }} ({{ betting_data.over_under_bets.over.odds }})</span>
                        </div>
                        <div class="probability-bar" id="overUnderJuiceAdjusted"
                             data-away-prob="{{ betting_data.over_under_bets.under.probability }}"
                             data-home-prob="{{ betting_data.over_under_bets.over.probability }}"
                             data-juice="{{ betting_data.over_under_bets.under.juice }}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Comparison Feature Container -->
        {% if comparison_data %}
        <div id="comparison-chart-container" class="mb-3">
            <canvas id="comparisonChart"></canvas>
        </div>
        {% endif %}

        <!-- Add this div to encapsulate the chat messages -->
        <div class="chat-box-header">Game Chat</div>
        <div class="chat-box">
            <ul id="messages">
                {% for message in messages %}
                    <li>{{ message.text }}</li>
                {% endfor %}
            </ul>
        </div>
        <div class="input-group">
            <input type="text" id="myMessage" class="form-control" placeholder="Type your message here...">
            <button onclick="sendMessage()" class="btn btn-send"><i class="fas fa-paper-plane"></i></button>
        </div>
        <div class="input-group">
            <span id="countdown"></span>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script type="text/javascript" src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="/static/js/socketEvents.js"></script>
<script src="/static/js/uiUpdates.js"></script>
<script src="/static/js/utils.js"></script>

{% if comparison_data %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        console.log('DOM fully loaded and parsed');

        // Data passed from the backend
        const comparisonDataStr = {{ comparison_data|safe }};
        console.log('Comparison Data String:', comparisonDataStr);

        // Explicitly parse JSON string
        let comparisonData;
        try {
            comparisonData = JSON.parse(comparisonDataStr);
            console.log('Parsed Comparison Data:', comparisonData);
        } catch (error) {
            console.error('Error parsing JSON:', error);
        }

        // Define the calculateZScore function
        function calculateZScore(value, avg, stdDev) {
            console.log(`Calculating Z-Score for value: ${value}, avg: ${avg}, stdDev: ${stdDev}`);
            return (value - avg) / stdDev;
        }

        // Ensure comparisonData is defined
        if (comparisonData && comparisonData.teams && comparisonData.teams.length >= 2) {
            console.log('Data structure is correct');

            // Prepare data for the chart
            const teamA = comparisonData.teams[0];
            const teamB = comparisonData.teams[1];
            const leagueAverages = comparisonData.leagueAverages;
            const leagueStdDevs = comparisonData.leagueStdDevs;

            console.log('Team A:', teamA.name);
            console.log('Team B:', teamB.name);
            console.log('League Averages:', leagueAverages);
            console.log('League StdDevs:', leagueStdDevs);

            const labels = [
                'Home Goals',
                'Away Goals',
                'Home Shots on Target',
                'Away Shots on Target',
                'Home Passing Accuracy',
                'Away Passing Accuracy',
                'Home Saves',
                'Away Saves',
                'Home Tackles',
                'Away Tackles'
            ];

            const teamAData = [
                calculateZScore(teamA.metrics.home_goals, leagueAverages.home_goals, leagueStdDevs.home_goals),
                calculateZScore(teamA.metrics.away_goals, leagueAverages.away_goals, leagueStdDevs.away_goals),
                calculateZScore(teamA.metrics.home_Shots_on_Target_value, leagueAverages.home_Shots_on_Target_value, leagueStdDevs.home_Shots_on_Target_value),
                calculateZScore(teamA.metrics.away_Shots_on_Target_value, leagueAverages.away_Shots_on_Target_value, leagueStdDevs.away_Shots_on_Target_value),
                calculateZScore(teamA.metrics.home_Passing_Accuracy_value, leagueAverages.home_Passing_Accuracy_value, leagueStdDevs.home_Passing_Accuracy_value),
                calculateZScore(teamA.metrics.away_Passing_Accuracy_value, leagueAverages.away_Passing_Accuracy_value, leagueStdDevs.away_Passing_Accuracy_value),
                calculateZScore(teamA.metrics.home_Saves_value, leagueAverages.home_Saves_value, leagueStdDevs.home_Saves_value),
                calculateZScore(teamA.metrics.away_Saves_value, leagueAverages.away_Saves_value, leagueStdDevs.away_Saves_value),
                calculateZScore(teamA.metrics.home_Tackles, leagueAverages.home_Tackles, leagueStdDevs.home_Tackles),
                calculateZScore(teamA.metrics.away_Tackles, leagueAverages.away_Tackles, leagueStdDevs.away_Tackles)
            ];

            const teamBData = [
                calculateZScore(teamB.metrics.home_goals, leagueAverages.home_goals, leagueStdDevs.home_goals),
                calculateZScore(teamB.metrics.away_goals, leagueAverages.away_goals, leagueStdDevs.away_goals),
                calculateZScore(teamB.metrics.home_Shots_on_Target_value, leagueAverages.home_Shots_on_Target_value, leagueStdDevs.home_Shots_on_Target_value),
                calculateZScore(teamB.metrics.away_Shots_on_Target_value, leagueAverages.away_Shots_on_Target_value, leagueStdDevs.away_Shots_on_Target_value),
                calculateZScore(teamB.metrics.home_Passing_Accuracy_value, leagueAverages.home_Passing_Accuracy_value, leagueStdDevs.home_Passing_Accuracy_value),
                calculateZScore(teamB.metrics.away_Passing_Accuracy_value, leagueAverages.away_Passing_Accuracy_value, leagueStdDevs.away_Passing_Accuracy_value),
                calculateZScore(teamB.metrics.home_Saves_value, leagueAverages.home_Saves_value, leagueStdDevs.home_Saves_value),
                calculateZScore(teamB.metrics.away_Saves_value, leagueAverages.away_Saves_value, leagueStdDevs.away_Saves_value),
                calculateZScore(teamB.metrics.home_Tackles, leagueAverages.home_Tackles, leagueStdDevs.home_Tackles),
                calculateZScore(teamB.metrics.away_Tackles, leagueAverages.away_Tackles, leagueStdDevs.away_Tackles)
            ];

            console.log('Team A Data:', teamAData);
            console.log('Team B Data:', teamBData);

            const barData = {
                labels: labels,
                datasets: [
                    {
                        label: teamA.name,
                        data: teamAData,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        barPercentage: 0.5,
                        categoryPercentage: 0.5
                    },
                    {
                        label: teamB.name,
                        data: teamBData,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        barPercentage: 0.5,
                        categoryPercentage: 0.5
                    }
                ]
            };

            const barOptions = {
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 2,
                        min: -2,
                        title: {
                            display: true,
                            text: 'Standard Deviations from Average'
                        },
                        grid: {
                            color: function(context) {
                                if (context.tick.value === 0) {
                                    return '#000'; // Vertical line for average
                                }
                                return '#e0e0e0'; // Other grid lines
                            }
                        },
                        ticks: {
                            callback: function(value) {
                                if (value === 0) return 'Average';
                                return value > 0 ? `+${value} SD` : `${value} SD`;
                            }
                        }
                    },
                    y: {
                        stacked: false
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.raw.toFixed(2);
                                return label;
                            }
                        }
                    }
                }
            };

            // Initialize the bar chart
            const barCtx = document.getElementById('comparisonChart').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: barData,
                options: barOptions
            });
            console.log('Chart initialized successfully');
        } else {
            console.error('Data structure is incorrect or incomplete');
            console.log('Comparison Data:', comparisonData);
        }
    });
</script>

{% endif %}

</body>
</html>
